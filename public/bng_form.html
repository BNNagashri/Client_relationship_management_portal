<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client Data Form</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        .hidden { display: none; }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

<div class="w-full max-w-md mx-auto bg-white p-8 rounded-xl shadow-lg fade-in">
    <h2 class="text-2xl font-bold mb-6 text-center">Enter Client Details</h2>
    
    <!-- Form Fields -->
    <form id="clientForm" class="space-y-4" enctype="multipart/form-data">
        <label class="block">
            <span class="text-gray-700">Name</span>
            <input type="text" id="name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500" required>
        </label>

        <label class="block">
            <span class="text-gray-700">Company Name</span>
            <input type="text" id="companyName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500" required>
        </label>

        <label class="block">
            <span class="text-gray-700">Phone Number</span>
            <input type="text" id="phoneNumber" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500" required pattern="^\d{10}$" title="Please enter a 10-digit phone number">
        </label>
        

        <label class="block">
            <span class="text-gray-700">Email</span>
            <input type="email" id="email" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500" required>
        </label>

        <label class="block">
            <span class="text-gray-700">Strategy Partner</span>
            <div class="mt-2 space-y-2">
                <label class="flex items-center">
                    <input type="radio" name="strategyPartner" value="Partner A" class="mr-2 text-indigo-600">
                    <span>Partner A</span>
                </label>
                <label class="flex items-center">
                    <input type="radio" name="strategyPartner" value="Partner B" class="mr-2 text-indigo-600">
                    <span>Partner B</span>
                </label>
                <label class="flex items-center">
                    <input type="radio" name="strategyPartner" value="Partner C" class="mr-2 text-indigo-600">
                    <span>Partner C</span>
                </label>
            </div>
        </label>

        <label class="block">
            <span class="text-gray-700">Domain</span>
            <input type="text" id="domain" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500" required>
        </label>

        <label class="block">
            <span class="text-gray-700">Notes</span>
            <textarea id="notes" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500"></textarea>
        </label>

        <!-- Visiting Card Checkbox -->
        <div class="flex items-center mb-4">
            <input type="checkbox" id="hasVisitingCard" class="h-4 w-4 text-indigo-600">
            <label for="hasVisitingCard" class="ml-2 text-gray-700">Client has a visiting card</label>
        </div>

        <div id="visitingCardFields" class="hidden">
            <label class="block">
                <span class="text-gray-700">Capture Visiting Card (Front)</span>
                <video id="cameraFront" autoplay class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500"></video>
                <img id="frontImagePreview" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm hidden" />
                <button type="button" onclick="capturePhoto('front')" id="captureFrontButton" class="mt-2 px-4 py-2 bg-green-500 text-white rounded">Capture Front</button>
                <button type="button" onclick="retakePhoto('front')" id="retakeFrontButton" class="mt-2 px-4 py-2 bg-red-500 text-white rounded hidden">Retake Front</button>
            </label>
            
            <label class="block">
                <span class="text-gray-700">Capture Visiting Card (Back)</span>
                <video id="cameraBack" autoplay class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500"></video>
                <img id="backImagePreview" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm hidden" />
                <button type="button" onclick="capturePhoto('back')" id="captureBackButton" class="mt-2 px-4 py-2 bg-green-500 text-white rounded">Capture Back</button>
                <button type="button" onclick="retakePhoto('back')" id="retakeBackButton" class="mt-2 px-4 py-2 bg-red-500 text-white rounded hidden">Retake Back</button>
            </label>
        </div>

        <!-- Submit Button -->
        <button type="submit" class="w-full py-2 mt-4 text-white bg-green-500 rounded-md hover:bg-green-600">Submit</button>
    </form>

    <button type="button" onclick="viewDashboard()" class="w-full py-2 mt-4 text-white bg-blue-500 rounded-md hover:bg-blue-600">View Dashboard</button>
</div>

<script>


    function viewDashboard() {
        window.location.href = '/bng_dashboard.html';
    }


    let frontImageBlob = null;
    let backImageBlob = null;
    let frontCameraStream = null;
    let backCameraStream = null;

    // Function to access the camera and display the live video
    function startCamera(videoElement) {
        navigator.mediaDevices.getUserMedia({ video: true })
            .then((stream) => {
                videoElement.srcObject = stream;
                if (videoElement.id === "cameraFront") {
                    frontCameraStream = stream; // Save stream to stop it later
                } else {
                    backCameraStream = stream; // Save stream to stop it later
                }
            })
            .catch((err) => {
                console.error("Error accessing camera: ", err);
                alert("Failed to access camera. Please ensure camera permissions are granted.");
            });
    }

    // Show video elements when the checkbox is checked
    document.getElementById('hasVisitingCard').addEventListener('change', function () {
        const visitingCardFields = document.getElementById('visitingCardFields');
        if (this.checked) {
            visitingCardFields.classList.remove('hidden');
            startCamera(document.getElementById('cameraFront'));
            startCamera(document.getElementById('cameraBack'));
        } else {
            visitingCardFields.classList.add('hidden');
            stopCameraStreams();
        }
    });

    function stopCameraStreams() {
        if (frontCameraStream) frontCameraStream.getTracks().forEach(track => track.stop());
        if (backCameraStream) backCameraStream.getTracks().forEach(track => track.stop());
    }

    // Capture photo function for front and back
    function capturePhoto(side) {
        const video = document.getElementById(`camera${side.charAt(0).toUpperCase() + side.slice(1)}`);
        const canvas = document.createElement("canvas");
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        
        // Draw the video frame on the canvas
        canvas.getContext("2d").drawImage(video, 0, 0);

        // Convert the canvas to a blob and store it
        canvas.toBlob((blob) => {
            const imagePreview = document.getElementById(`${side}ImagePreview`);
            const captureButton = document.getElementById(`capture${side.charAt(0).toUpperCase() + side.slice(1)}Button`);
            const retakeButton = document.getElementById(`retake${side.charAt(0).toUpperCase() + side.slice(1)}Button`);

            if (side === 'front') {
                frontImageBlob = blob;
            } else {
                backImageBlob = blob;
            }

            // Display the captured image and hide the video
            imagePreview.src = URL.createObjectURL(blob);
            imagePreview.classList.remove('hidden');
            video.classList.add('hidden');
            captureButton.classList.add('hidden');
            retakeButton.classList.remove('hidden');
        }, 'image/jpeg');
    }

    // Retake photo function
    function retakePhoto(side) {
        const video = document.getElementById(`camera${side.charAt(0).toUpperCase() + side.slice(1)}`);
        const imagePreview = document.getElementById(`${side}ImagePreview`);
        const captureButton = document.getElementById(`capture${side.charAt(0).toUpperCase() + side.slice(1)}Button`);
        const retakeButton = document.getElementById(`retake${side.charAt(0).toUpperCase() + side.slice(1)}Button`);

        // Hide the image preview and show the video again
        imagePreview.classList.add('hidden');
        video.classList.remove('hidden');
        captureButton.classList.remove('hidden');
        retakeButton.classList.add('hidden');

        // Restart the camera for retaking the photo
        startCamera(video);
    }

    document.getElementById('clientForm').addEventListener('submit', async function (e) {
        e.preventDefault();
      
        const formData = new FormData();
        formData.append("name", document.getElementById("name").value);
        formData.append("companyName", document.getElementById("companyName").value);
        formData.append("phoneNumber", document.getElementById("phoneNumber").value);
        formData.append("email", document.getElementById("email").value);
        formData.append("domain", document.getElementById("domain").value);
        formData.append("notes", document.getElementById("notes").value);
        formData.append("hasVisitingCard", document.getElementById("hasVisitingCard").checked);


         // Get the selected strategy partner
         const strategyPartner = document.querySelector('input[name="strategyPartner"]:checked');
         if (strategyPartner) {
             formData.append("strategyPartner", strategyPartner.value);
         }
      
        // Append captured images with field names matching multer config
        if (frontImageBlob) formData.append("front", frontImageBlob, "front.jpg");
        if (backImageBlob) formData.append("back", backImageBlob, "back.jpg");
      
        try {
          const response = await fetch('/submit-form', {
            method: 'POST',
            body: formData
          });
          const result = await response.json();
      
          if (response.ok) {
            alert(result.message);
          } else {
            console.error(result.error);
            alert("Error: " + result.error);
          }
        } catch (error) {
          console.error("Error submitting the form:", error);
          alert("Failed to submit the form.");
        }
      });
      
</script>
</body>
</html>
